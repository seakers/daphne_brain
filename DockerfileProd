FROM python:3.8-slim-buster



# --> 0. Preliminary Updates
RUN apt-get -y update &&\
    apt-get -y install build-essential manpages-dev &&\
    apt-get clean && apt-get autoclean && apt-get autoremove


# --> 1. Copy Requiresments + Install
WORKDIR /installs
COPY requirements.txt /installs/requirements.txt
RUN pip3 install --no-cache-dir -r ./requirements.txt
RUN spacy download en_core_web_sm


# --> 2. Install Supervisor.d
WORKDIR /run/daphne
WORKDIR /etc/supervisor
RUN pip3 install --no-cache-dir supervisor
RUN mkdir /var/log/supervisor                 && \
    touch /var/log/supervisor/supervisord.log
COPY ./supervisord.conf  /etc/supervisor


# --> 3. Copy Brain + create dirs
WORKDIR /app
#COPY ./config /app
#COPY ./AT /app
#COPY ./daphne_context /app
#COPY ./dialogue /app
#COPY ./EDL /app
#COPY ./example_problem /app
#COPY ./experiment /app
#COPY ./experiment_at /app
#COPY ./iFEED_API /app
#COPY ./mycroft /app
#COPY ./test /app
#COPY ./vassar_db /app
#COPY ./EOSS /app
#COPY ./daphne_brain /app
#COPY ./daphne_ws /app
#COPY ./auth_API /app
COPY ./. /app


# --> 4. Ensure Django Migrations are Applied (DEPRECATED)
#RUN python3 manage.py migrate --run-syncdb


# --> 5. Run app
WORKDIR /app
RUN chmod +x /app/run_prod.sh
CMD /app/run_prod.sh